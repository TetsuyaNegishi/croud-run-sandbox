version: 2.1

orbs:
  node: circleci/node@5.0.0

executors:
  basic-executor:
    docker:
      - image: 'cimg/base:stable'

jobs:
  express-job:
    executor: basic-executor
    working_directory: ~/express-work/express
    steps:
      - checkout:
          path: ~/express-work
      - run:
          name: 'if change express'
          command: |
            if ! ../.circleci/is_changed_directories.sh express "origin/main" ; then
              echo "express に変更がありません"
              circleci step halt
            fi
      - node/install:
          install-yarn: true
          node-version: '16.13'
      - run: node --version
      - run: yarn install
      - run: yarn test
  fastify-job:
    executor: basic-executor
    working_directory: ~/express-work/fastify
    steps:
      - checkout:
          path: ~/express-work
      - run:
          name: 'if change fastify'
          command: |
            if ! ../.circleci/is_changed_directories.sh fastify "origin/main" ; then
              echo "fastify に変更がありません"
              circleci step halt
            fi
      - node/install:
          install-yarn: true
          node-version: '16.13'
      - run: node --version
      - run: yarn install
      - run: yarn test

workflows:
  test:
    jobs:
      - express-job
      - fastify-job
